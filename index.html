<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìˆ˜í•™ ë¬¸ì œ ë·°ì–´</title>

    <!-- KaTeX CSS and JS from CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        background-color: #f5f5f5; 
        padding: 20px; 
        line-height: 1.6; 
      }
      .container { 
        max-width: 1800px; 
        margin: 0 auto; 
        background: white; 
        border-radius: 10px; 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        overflow: hidden; 
      }
      .header { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        color: white; 
        padding: 20px 30px; 
        text-align: center; 
      }
      .header h1 { font-size: 2rem; margin-bottom: 8px; }
      .header p { opacity: 0.9; font-size: 1.1rem; }
      
      .navigation-bar {
        background: #f8f9fa;
        padding: 15px 30px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        flex-wrap: wrap;
      }
      @media (max-width: 1200px) {
        .navigation-bar {
          flex-direction: column;
          align-items: stretch;
        }
        .nav-controls {
          justify-content: center;
        }
        .search-section {
          justify-content: center;
        }
      }
      .nav-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .btn-nav {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .btn-nav:hover:not(:disabled) {
        background: #e9ecef;
      }
      .btn-nav:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .problem-counter {
        font-weight: 600;
        color: #495057;
        min-width: 150px;
        text-align: center;
      }
      .search-section {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .search-input {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        width: 120px;
      }
      .search-button {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
      }
      .search-button:hover {
        background: #e9ecef;
      }
      .search-label {
        font-size: 0.9rem;
        color: #6c757d;
      }
      .file-loading {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 30px;
        font-size: 14px;
      }
      .file-input-section {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 20px;
        margin: 10px 30px;
      }
      .file-input-section h3 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 1.1rem;
      }
      .drop-zone {
        border: 2px dashed #667eea;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 20px;
      }
      .drop-zone:hover {
        border-color: #5568d3;
        background: #f0f4ff;
      }
      .drop-zone.dragover {
        border-color: #28a745;
        background: #f0fff4;
      }
      .drop-zone-text {
        font-size: 1.1rem;
        color: #495057;
        margin-bottom: 10px;
      }
      .drop-zone-hint {
        font-size: 0.9rem;
        color: #6c757d;
      }
      .file-input-hidden {
        display: none;
      }
      .file-list {
        margin-top: 20px;
      }
      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        margin-bottom: 8px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
      }
      .file-item-name {
        flex: 1;
        font-weight: 600;
        color: #495057;
      }
      .file-item-type {
        font-size: 0.85rem;
        color: #6c757d;
        margin-left: 10px;
      }
      .file-item-status {
        font-size: 0.85rem;
        padding: 4px 8px;
        border-radius: 12px;
        margin-left: 10px;
      }
      .file-item-status.loaded {
        background: #d4edda;
        color: #155724;
      }
      .file-item-status.missing {
        background: #f8d7da;
        color: #721c24;
      }
      .file-item-status.optional {
        background: #fff3cd;
        color: #856404;
      }
      .load-button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: background 0.2s;
      }
      .load-button:hover:not(:disabled) {
        background: #0056b3;
      }
      .load-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      
      .main-content { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        height: calc(100vh - 250px); 
        min-height: 600px; 
      }
      .left-section { 
        border-right: 1px solid #e0e0e0; 
        display: flex; 
        flex-direction: column; 
        min-height: 0;
      }
      .right-section { 
        display: flex; 
        flex-direction: column; 
        min-height: 0;
      }
      .section-header { 
        background: #f8f9fa; 
        padding: 15px 20px; 
        border-bottom: 1px solid #e0e0e0; 
        font-weight: 600; 
        color: #495057; 
      }
      .problem-content { 
        flex: 1; 
        padding: 20px; 
        overflow-y: auto; 
        background: white;
        min-height: 0;
      }
      .info-content { 
        flex: 1; 
        padding: 20px; 
        overflow-y: auto; 
        background: white;
        min-height: 0;
      }
      
      /* KaTeX ìŠ¤íƒ€ì¼ */
      .katex { font-size: 1.1em; }
      .katex-display { margin: 1em 0; }
      
      /* ë¬¸ì œ ë‚´ìš© ìŠ¤íƒ€ì¼ */
      .problem-content img {
        max-width: 100%;
        height: auto;
      }
      .problem-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
      }
      .problem-content table td {
        padding: 5px;
      }
      
      /* ì •ë³´ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
      .info-section {
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e9ecef;
      }
      .info-section:last-child {
        border-bottom: none;
      }
      .info-section h3 {
        color: #495057;
        margin-bottom: 12px;
        font-size: 1.1rem;
        padding-bottom: 8px;
        border-bottom: 2px solid #667eea;
      }
      .info-field {
        margin-bottom: 12px;
      }
      .info-label {
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }
      .info-value {
        color: #212529;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        line-height: 1.5;
      }
      .info-value.editable {
        cursor: pointer;
        transition: background 0.2s;
      }
      .info-value.editable:hover {
        background: #e9ecef;
      }
      .edit-textarea, .edit-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #667eea;
        border-radius: 4px;
        font-family: inherit;
        font-size: inherit;
        line-height: 1.5;
        resize: vertical;
      }
      .edit-textarea {
        min-height: 80px;
      }
      .edit-controls {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
      }
      .btn-edit {
        padding: 8px 16px;
        border: 1px solid #667eea;
        background: #667eea;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      .btn-edit:hover {
        background: #5568d3;
      }
      .btn-save {
        padding: 8px 16px;
        border: 1px solid #28a745;
        background: #28a745;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      .btn-save:hover {
        background: #218838;
      }
      .btn-cancel {
        padding: 8px 16px;
        border: 1px solid #6c757d;
        background: #6c757d;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      .btn-cancel:hover {
        background: #5a6268;
      }
      .edit-mode-indicator {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 15px;
        color: #856404;
        font-weight: 600;
      }
      .unit-candidate {
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: #fafafa;
      }
      .unit-candidate-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .confidence-score {
        background: #667eea;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
      }
      .knowledge-item {
        margin-top: 8px;
        padding: 8px;
        background: white;
        border-left: 3px solid #667eea;
        margin-left: 10px;
      }
      .knowledge-name-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 5px;
      }
      .knowledge-name {
        font-weight: 600;
        color: #495057;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .knowledge-checked-icon {
        font-size: 1.2em;
      }
      .unit-candidate-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }
      .unit-name-group {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
      }
      .unit-name {
        font-weight: 600;
        color: #495057;
      }
      .unit-meta {
        font-size: 0.85rem;
        color: #6c757d;
      }
      .necessity-inline-group {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
      }
      .necessity-radio {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
      }
      .necessity-radio-circle {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid #ccc;
        background-color: #ffffff;
        box-sizing: border-box;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .necessity-radio-true .necessity-radio-circle {
        border-color: #28a745;
      }
      .necessity-radio-false .necessity-radio-circle {
        border-color: #dc3545;
      }
      .necessity-radio-true.active .necessity-radio-circle::after {
        content: '';
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #28a745;
        display: block;
      }
      .necessity-radio-false.active .necessity-radio-circle::after {
        content: '';
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #dc3545;
        display: block;
      }
      .necessity-radio-label {
        font-size: 0.85rem;
        color: #6c757d;
      }
      /* í–‰ë™ ì˜ì—­ ë“œë¡­ë‹¤ìš´ */
      .behavior-area-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        font-size: 1rem;
      }
      .behavior-area-original {
        flex: 1;
      }
      .info-value.behavior-area-row {
        padding-top: 10px;
        padding-bottom: 10px;
      }
      .behavior-dropdown {
        position: relative;
  min-width: 0;
      }
      /* í–‰ë™ ì˜ì—­ ë“œë¡­ë‹¤ìš´ì€ ê³ ì • ë„ˆë¹„ ì‚¬ìš© */
      .behavior-area-row .behavior-dropdown {
        width: 260px;
        min-width: 260px;
      }
      /* 1. ê²€ìƒ‰ í–‰: Grid ì‚¬ìš©, ì ˆëŒ€ì ì¸ ì¹¸ ë‚˜ëˆ„ê¸° */
      .knowledge-search-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 40px;
        gap: 10px;
        align-items: start;
        width: 100%;
      }

      /* 2. ê²€ìƒ‰ ì—´: Gridê°€ ë„ˆë¹„ í†µì œ */
      .knowledge-search-col {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }

      /* 3. ë“œë¡­ë‹¤ìš´ í† ê¸€: ë†’ì´ 40px ê³ ì •, ë°•ìŠ¤ ëª¨ë¸ ì—„ê²© ì ìš© */
      .behavior-dropdown-toggle {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 10px;
        height: 40px !important;
        min-height: 40px !important;
        max-height: 40px !important;
        border: none;
        border-radius: 12px;
        background: #667eea;
        color: #ffffff;
        font-size: 1rem;
        font-family: inherit;
        line-height: 1;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        box-sizing: border-box;
        overflow: hidden;
      }

      /* ë“œë¡­ë‹¤ìš´ ë‚´ë¶€ í…ìŠ¤íŠ¸ */
      .behavior-dropdown-label {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left;
        margin: 0;
        padding: 0;
      }
      .behavior-dropdown-label.placeholder {
        font-style: italic;
        opacity: 0.8;
      }
      .behavior-dropdown-arrow {
        font-size: 0.75rem;
        margin-left: 8px;
        transition: transform 0.15s ease-in-out;
      }
      .behavior-dropdown.open .behavior-dropdown-arrow {
        transform: rotate(180deg);
      }
      .behavior-dropdown-menu {
        position: absolute;
        right: 0;
        top: calc(100% + 4px);
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        min-width: 140px;
        max-height: 220px;
        overflow-y: auto;
        display: none;
        z-index: 20;
      }
      .behavior-dropdown.open .behavior-dropdown-menu {
        display: block;
      }
      .behavior-dropdown-item {
        padding: 8px 12px;
        font-size: 1rem;
        cursor: pointer;
        white-space: nowrap;
      }
      .behavior-dropdown-item:hover {
        background: #f1f3f5;
      }
      .behavior-dropdown-item.placeholder {
        font-style: italic;
        color: #6c757d;
      }
      /* ë‹¨ì›/ì§€ì‹ ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ */
      .knowledge-search-container {
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid #e9ecef;
      }
      .knowledge-search-row {
        display: grid !important;
        grid-template-columns: 1fr 1fr 1fr 40px !important;
        gap: 10px;
        align-items: start;
        width: 100%;
      }
      .knowledge-search-col {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }
      .knowledge-search-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0;
        line-height: 1.5;
        white-space: nowrap;
      }
      .behavior-dropdown-toggle,
      .knowledge-add-button {
        width: 100% !important;
        height: 40px !important;
        min-height: 40px !important;
        padding: 0 10px;
        border-radius: 12px;
        box-sizing: border-box;
        margin: 0 !important;
        display: flex;
        align-items: center;
        cursor: pointer;
        line-height: 1;
      }
      .behavior-dropdown-toggle {
        justify-content: space-between;
        background: #667eea;
        color: #ffffff;
        border: none;
        font-size: 1rem;
      }
      .knowledge-add-button {
        border: 1px solid #28a745;
        background: #ffffff;
        color: #28a745;
        font-size: 24px;
        justify-content: center;
        border-radius: 50%;
        padding: 0;
      }
      .knowledge-add-button:hover {
        background: #28a745;
        color: #ffffff;
      }
      .behavior-dropdown-label {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left;
      }
      /* ê²€ìƒ‰ ì…ë ¥ì´ í¬í•¨ëœ ë“œë¡­ë‹¤ìš´ìš© ê²€ìƒ‰ í•„ë“œ */
      .behavior-dropdown-search {
        width: 100%;
        padding: 6px 8px;
        margin: 4px 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.9rem;
        box-sizing: border-box;
      }
      .dropdown-item-hidden {
        display: none !important;
      }
      .unit-added-box {
        margin-top: 10px;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #dc3545;
        background: #fff;
      }
      .unit-candidate.unit-candidate-added {
        border-color: #dc3545;
      }
      .unit-added-item {
        font-size: 0.9rem;
        color: #495057;
      }
      .unit-added-knowledge {
        margin-top: 8px;
        padding: 8px;
        background: white;
        border-left: 3px solid #dc3545;
        margin-left: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .unit-added-knowledge-name {
        flex: 1;
        font-weight: 600;
        color: #495057;
      }
      .btn-unit-added-delete {
        border: 1px solid #dc3545;
        background: #ffffff;
        color: #dc3545;
        padding: 4px 10px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.15s;
      }
      .btn-unit-added-delete:hover {
        background: #dc3545;
        color: #ffffff;
      }
      .comment-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
      }
      .comment-textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        font-size: 0.9rem;
        line-height: 1.5;
        resize: vertical;
      }
      .save-section {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        text-align: center;
      }
      .btn-save-file {
        padding: 10px 24px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background 0.2s;
      }
      .btn-save-file:hover {
        background: #218838;
      }
      .btn-save-file:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      
      @media (max-width: 1200px) { 
        .main-content { 
          grid-template-columns: 1fr; 
          grid-template-rows: 1fr 1fr; 
        } 
        .left-section { 
          border-right: none; 
          border-bottom: 1px solid #e0e0e0; 
        } 
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ìˆ˜í•™ ë¬¸ì œ ë·°ì–´</h1>
        <p>combined_input.jsonl, results.jsonl, units.json, criteria.jsonl ë°ì´í„° í†µí•© ë·°ì–´</p>
      </div>

      <div class="file-input-section" id="file-input-section">
        <h3>íŒŒì¼ ì—…ë¡œë“œ</h3>
        
        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
          <div class="drop-zone-text">ğŸ“ íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</div>
          <div class="drop-zone-hint">ì—¬ëŸ¬ íŒŒì¼ì„ í•œë²ˆì— ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
          <input type="file" id="file-input" class="file-input-hidden" multiple accept=".json,.jsonl" onchange="handleFilesSelected(this.files)">
        </div>
        
        <div class="file-list" id="file-list">
          <div class="file-item">
            <div class="file-item-name">combined_input.jsonl</div>
            <div class="file-item-type">í•„ìˆ˜</div>
            <div class="file-item-status missing" id="status-combined">í•„ìš”</div>
          </div>
          <div class="file-item">
            <div class="file-item-name">results.jsonl</div>
            <div class="file-item-type">í•„ìˆ˜</div>
            <div class="file-item-status missing" id="status-results">í•„ìš”</div>
          </div>
          <div class="file-item">
            <div class="file-item-name">unitKnowledge.json</div>
            <div class="file-item-type">í•„ìˆ˜</div>
            <div class="file-item-status missing" id="status-unitKnowledge">í•„ìš”</div>
          </div>
          <div class="file-item">
            <div class="file-item-name">criteria.jsonl</div>
            <div class="file-item-type">ì„ íƒ</div>
            <div class="file-item-status optional" id="status-criteria">ì„ íƒì‚¬í•­</div>
          </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
          <button class="load-button" id="load-button" onclick="loadAllFiles()" disabled>ë°ì´í„° ë¡œë“œí•˜ê¸°</button>
        </div>
      </div>

      <div class="file-loading" id="file-loading" style="display: none;">
        íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘...
      </div>

      <div class="navigation-bar" id="navigation-bar" style="display: none;">
        <div class="nav-controls">
          <button class="btn-nav" id="btn-first" onclick="goToFirst()">
            â® ë§¨ ì•
          </button>
          <button class="btn-nav" id="btn-prev10" onclick="changeProblem(-10)">
            âª 10ê°œ ì•
          </button>
          <button class="btn-nav" id="btn-prev" onclick="changeProblem(-1)">
            <span>â—€</span> ì´ì „
          </button>
          <div class="problem-counter" id="problem-counter">
            0 / 0
          </div>
          <button class="btn-nav" id="btn-next" onclick="changeProblem(1)">
            ë‹¤ìŒ <span>â–¶</span>
          </button>
          <button class="btn-nav" id="btn-next10" onclick="changeProblem(10)">
            10ê°œ ë’¤ <span>â©</span>
          </button>
          <button class="btn-nav" id="btn-last" onclick="goToLast()">
            ë§¨ ë’¤ â­
          </button>
        </div>
        <div class="search-section">
          <span class="search-label">ë²ˆí˜¸:</span>
          <input type="number" id="search-index" class="search-input" placeholder="ë²ˆí˜¸ ì…ë ¥" min="1" onkeypress="handleIndexSearch(event)">
          <button class="search-button" onclick="searchByIndex()">ì´ë™</button>
          <span class="search-label" style="margin-left: 15px;">Problem ID:</span>
          <input type="number" id="search-problem-id" class="search-input" placeholder="ID ì…ë ¥" onkeypress="handleProblemIdSearch(event)">
          <button class="search-button" onclick="searchByProblemId()">ê²€ìƒ‰</button>
          <button class="search-button" id="btn-edit-mode" onclick="enableEditMode()" style="margin-left: 15px; background: #667eea; color: white; border-color: #667eea;">í¸ì§‘ ëª¨ë“œë¡œ ì—´ê¸°</button>
        </div>
      </div>

      <div class="main-content" id="main-content" style="display: none;">
        <div class="left-section">
          <div class="section-header">ë¬¸ì œ ë‚´ìš©</div>
          <div class="problem-content" id="problem-content">
            <p style="color: #6c757d; font-style: italic;">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</p>
          </div>
        </div>

        <div class="right-section">
          <div class="section-header">ë¬¸ì œ ì •ë³´</div>
          <div class="info-content" id="info-content">
            <p style="color: #6c757d; font-style: italic;">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      let combinedInputData = [];
      let resultsData = [];
      let unitsData = {}; // unitKnowledge.jsonì—ì„œ ìƒì„±í•œ unit ì •ë³´ ë§µ
      let criteriaData = [];
      let mergedData = [];
      let currentIndex = 0;
      let unitKnowledgeList = [];
      // problem_idë³„ ì§€ì‹ ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ìƒíƒœ
      let knowledgeSearchStates = {};
      
      let selectedFiles = {
        combined: null,
        results: null,
        criteria: null,
        unitKnowledge: null
      };

      // í•„ìš”/ë¶ˆí•„ìš” ì›í˜• ë¼ë””ì˜¤ UI HTML ìƒì„±
      function getNecessityControlsHtml(onclickTrue, onclickFalse, isTrueActive, isFalseActive) {
        return ''
          + '<div class="necessity-inline-group">'
          +   '<div class="necessity-radio necessity-radio-true' + (isTrueActive ? ' active' : '') + '" onclick="' + onclickTrue + '">'
          +     '<span class="necessity-radio-circle"></span>'
          +     '<span class="necessity-radio-label">í•„ìš”</span>'
          +   '</div>'
          +   '<div class="necessity-radio necessity-radio-false' + (isFalseActive ? ' active' : '') + '" onclick="' + onclickFalse + '">'
          +     '<span class="necessity-radio-circle"></span>'
          +     '<span class="necessity-radio-label">ë¶ˆí•„ìš”</span>'
          +   '</div>'
          + '</div>';
      }

      // ë‹¨ì›/ì§€ì‹ ê²€ìƒ‰ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
      function getKnowledgeSearchState(problemId) {
        if (!knowledgeSearchStates[problemId]) {
          knowledgeSearchStates[problemId] = {
            curriculum_name: '',
            unit_id: null,
            knowledge_id: null
          };
        }
        return knowledgeSearchStates[problemId];
      }

      function getFilteredUnitKnowledge(state) {
        let list = unitKnowledgeList || [];
        if (state.curriculum_name) {
          list = list.filter(item => item.curriculum_name === state.curriculum_name);
        }
        if (state.unit_id) {
          list = list.filter(item => item.unit_id === state.unit_id);
        }
        if (state.knowledge_id) {
          list = list.filter(item => item.knowledge_id === state.knowledge_id);
        }
        return list;
      }

      function getCurriculumOptions(state) {
        const list = getFilteredUnitKnowledge(state);
        const set = new Set();
        const options = [];
        list.forEach(item => {
          if (!set.has(item.curriculum_name)) {
            set.add(item.curriculum_name);
            options.push(item.curriculum_name);
          }
        });
        return options;
      }

      function getUnitOptions(state) {
        const list = getFilteredUnitKnowledge(state);
        const map = new Map();
        list.forEach(item => {
          if (!map.has(item.unit_id)) {
            map.set(item.unit_id, item.unit_name);
          }
        });
        return Array.from(map.entries()).map(([unit_id, unit_name]) => ({ unit_id, unit_name }));
      }

      function getKnowledgeOptions(state) {
        const list = getFilteredUnitKnowledge(state);
        const map = new Map();
        list.forEach(item => {
          if (!map.has(item.knowledge_id)) {
            map.set(item.knowledge_id, item.knowledge_name);
          }
        });
        return Array.from(map.entries()).map(([knowledge_id, knowledge_name]) => ({ knowledge_id, knowledge_name }));
      }

      function getKnowledgeSearchHtml(problemId, problemIndex) {
        if (!unitKnowledgeList || unitKnowledgeList.length === 0) {
          return '';
        }
        const state = getKnowledgeSearchState(problemId);
        const curriculumOptions = getCurriculumOptions(state);
        const unitOptions = getUnitOptions(state);
        const knowledgeOptions = getKnowledgeOptions(state);

        function buildDropdown(label, placeholder, currentText, isPlaceholder, options, onclickBuilder, dropdownType) {
          let menuHtml = '';
          // ê²€ìƒ‰ ì…ë ¥
          menuHtml += '<input type="text" class="behavior-dropdown-search" placeholder="ê²€ìƒ‰..." oninput="filterDropdown(this)" />';
          // placeholder ì„ íƒ í•­ëª©
          menuHtml += '<div class="behavior-dropdown-item behavior-dropdown-item-option placeholder" onclick="' + onclickBuilder('') + '">' + escapeHtml(placeholder) + '</div>';
          // ì˜µì…˜ ëª©ë¡
          options.forEach(opt => {
            menuHtml += '<div class="behavior-dropdown-item behavior-dropdown-item-option" data-label="' + escapeHtml(opt.label || '') + '" onclick="' + onclickBuilder(opt.value) + '">' + escapeHtml(opt.label || '') + '</div>';
          });
          return ''
            + '<div class="knowledge-search-col">'
            +   '<div class="knowledge-search-label">' + escapeHtml(label) + '</div>'
            +   '<div class="behavior-dropdown">'
            +     '<button type="button" class="behavior-dropdown-toggle" data-problem-index="' + problemIndex + '" data-dropdown-type="' + dropdownType + '" onclick="toggleBehaviorDropdown(this)">'
            +       '<span class="behavior-dropdown-label' + (isPlaceholder ? ' placeholder' : '') + '">' + escapeHtml(currentText) + '</span>'
            +       '<span class="behavior-dropdown-arrow">â–¼</span>'
            +     '</button>'
            +     '<div class="behavior-dropdown-menu">'
            +       menuHtml
            +     '</div>'
            +   '</div>'
            + '</div>';
        }

        const curriculumCurrent = state.curriculum_name || 'êµìœ¡ê³¼ì • ì„ íƒ';
        const curriculumIsPlaceholder = !state.curriculum_name;
        const curriculumDropdown = buildDropdown(
          'êµìœ¡ê³¼ì •',
          'êµìœ¡ê³¼ì • ì„ íƒ',
          curriculumCurrent,
          curriculumIsPlaceholder,
          curriculumOptions.map(name => ({ value: name, label: name })),
          (val) => 'selectCurriculum(' + problemIndex + ', \'' + val + '\')',
          'curriculum'
        );

        const unitCurrent = state.unit_id
          ? (unitOptions.find(o => o.unit_id === state.unit_id)?.unit_name || 'ë‹¨ì› ì„ íƒ')
          : 'ë‹¨ì› ì„ íƒ';
        const unitIsPlaceholder = !state.unit_id;
        const unitDropdown = buildDropdown(
          'ë‹¨ì›',
          'ë‹¨ì› ì„ íƒ',
          unitCurrent,
          unitIsPlaceholder,
          unitOptions.map(u => ({ value: String(u.unit_id), label: u.unit_name })),
          (val) => 'selectUnit(' + problemIndex + ', ' + (val ? parseInt(val, 10) : 'null') + ')',
          'unit'
        );

        const knowledgeCurrent = state.knowledge_id
          ? (knowledgeOptions.find(o => o.knowledge_id === state.knowledge_id)?.knowledge_name || 'ê°œë… ì„ íƒ')
          : 'ê°œë… ì„ íƒ';
        const knowledgeIsPlaceholder = !state.knowledge_id;
        const knowledgeDropdown = buildDropdown(
          'ê°œë…',
          'ê°œë… ì„ íƒ',
          knowledgeCurrent,
          knowledgeIsPlaceholder,
          knowledgeOptions.map(k => ({ value: String(k.knowledge_id), label: k.knowledge_name })),
          (val) => 'selectKnowledge(' + problemIndex + ', ' + (val ? parseInt(val, 10) : 'null') + ')',
          'knowledge'
        );

        // ì¶”ê°€ ë²„íŠ¼ ì»¬ëŸ¼: Gridì—ì„œ 40px ê³ ì • í­ì„ ì‚¬ìš©í•˜ë„ë¡ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì œì–´
        const addButton = ''
          + '<div class="knowledge-search-col" style="width: 40px; min-width: 40px; max-width: 40px; flex: none;">'
          +   '<div class="knowledge-search-label" style="visibility: hidden;">ì¶”ê°€</div>'
          +   '<button type="button" class="knowledge-add-button" onclick="addUnitFromSearch(' + problemIndex + ')">+</button>'
          + '</div>';

        return ''
          + '<div class="knowledge-search-container">'
          +   '<div class="knowledge-search-wrapper">'
          +     '<div class="knowledge-search-row">'
          +       curriculumDropdown
          +       unitDropdown
          +       knowledgeDropdown
          +       addButton
          +     '</div>'
          +   '</div>'
          + '</div>';
      }
      // í–‰ë™ ì˜ì—­ ë“œë¡­ë‹¤ìš´ HTML ìƒì„±
      function getBehaviorAreaDropdownHtml(problemIndex, value) {
        const displayText = value || 'ë¯¸ì„ íƒ';
        const isPlaceholder = !value;
        const options = [
          { value: '', label: 'ë¯¸ì„ íƒ', isPlaceholder: true },
          { value: 'ê³„ì‚° ëŠ¥ë ¥', label: 'ê³„ì‚° ëŠ¥ë ¥' },
          { value: 'ì´í•´ ëŠ¥ë ¥', label: 'ì´í•´ ëŠ¥ë ¥' },
          { value: 'ì¶”ë¡  ëŠ¥ë ¥', label: 'ì¶”ë¡  ëŠ¥ë ¥' },
          { value: 'ë¬¸ì œ í•´ê²° ëŠ¥ë ¥', label: 'ë¬¸ì œ í•´ê²° ëŠ¥ë ¥' }
        ];

        let menuHtml = '';
        options.forEach(opt => {
          menuHtml += '<div class="behavior-dropdown-item'
            + (opt.isPlaceholder ? ' placeholder' : '')
            + '" onclick="setBehaviorAreaConfirmed(' + problemIndex + ', \'' + opt.value + '\')">'
            + opt.label
            + '</div>';
        });

        return ''
          + '<div class="behavior-dropdown" data-problem-index="' + problemIndex + '">'
          +   '<button type="button" class="behavior-dropdown-toggle" onclick="toggleBehaviorDropdown(this)">'
          +     '<span class="behavior-dropdown-label' + (isPlaceholder ? ' placeholder' : '') + '">' + displayText + '</span>'
          +     '<span class="behavior-dropdown-arrow">â–¼</span>'
          +   '</button>'
          +   '<div class="behavior-dropdown-menu">'
          +     menuHtml
          +   '</div>'
          + '</div>';
      }
      
      // File System Access APIìš© ë³€ìˆ˜
      let resultsFileHandle = null;

      // íŒŒì¼ëª…ê³¼ í™•ì¥ìë¡œ íŒŒì¼ íƒ€ì… ìë™ êµ¬ë¶„
      function identifyFileType(fileName) {
        const name = fileName.toLowerCase();
        if (name.includes('combined') && name.includes('input') && name.endsWith('.jsonl')) {
          return 'combined';
        } else if (name.includes('results') && name.endsWith('.jsonl')) {
          return 'results';
        } else if (name.includes('criteria') && name.endsWith('.jsonl')) {
          return 'criteria';
        } else if ((name.includes('unitknowledge') || name.includes('unit_knowledge')) && name.endsWith('.json')) {
          return 'unitKnowledge';
        }
        return null;
      }
      
      // ì—¬ëŸ¬ íŒŒì¼ ì²˜ë¦¬ (ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” íŒŒì¼ ì„ íƒ)
      function handleFilesSelected(files) {
        Array.from(files).forEach(file => {
          const fileType = identifyFileType(file.name);
          if (fileType) {
            selectedFiles[fileType] = file;
            updateFileStatus(fileType, file.name);
          }
        });
        checkAllFilesSelected();
      }
      
      // íŒŒì¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateFileStatus(type, fileName) {
        const statusElement = document.getElementById(`status-${type}`);
        if (statusElement) {
          statusElement.textContent = `âœ“ ${fileName}`;
          statusElement.className = 'file-item-status loaded';
        }
      }
      
      // ëª¨ë“  íŒŒì¼ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
      function checkAllFilesSelected() {
        const allSelected = selectedFiles.combined && selectedFiles.results && selectedFiles.unitKnowledge;
        document.getElementById('load-button').disabled = !allSelected;
      }
      
      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      function setupDragAndDrop() {
        const dropZone = document.getElementById('drop-zone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('dragover');
          }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('dragover');
          }, false);
        });
        
        dropZone.addEventListener('drop', (e) => {
          const files = e.dataTransfer.files;
          handleFilesSelected(files);
        }, false);
      }
      
      // íŒŒì¼ ì½ê¸° (Text)
      function readTextFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = (e) => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
          reader.readAsText(file, 'utf-8');
        });
      }
      
      // íŒŒì¼ ì½ê¸° (JSON)
      function readJsonFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              resolve(JSON.parse(e.target.result));
            } catch (err) {
              reject(new Error('JSON íŒŒì‹± ì‹¤íŒ¨: ' + err.message));
            }
          };
          reader.onerror = (e) => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
          reader.readAsText(file, 'utf-8');
        });
      }
      
      // File System Access APIë¡œ results.jsonl íŒŒì¼ ì—´ê¸°
      async function openResultsFileForEditing() {
        if (!window.showOpenFilePicker) {
          alert('File System Access APIê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome/Edge ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.');
          return false;
        }
        
        try {
          const [fileHandle] = await window.showOpenFilePicker({
            types: [{
              description: 'JSONL files',
              accept: { 'application/jsonl': ['.jsonl'] }
            }],
            multiple: false
          });
          
          if (fileHandle) {
            resultsFileHandle = fileHandle;
            // ì €ì¥ ë²„íŠ¼ í™œì„±í™”
            const saveBtn = document.getElementById('btn-save');
            if (saveBtn) {
              saveBtn.disabled = false;
            }
            // í¸ì§‘ ëª¨ë“œ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            const editBtn = document.getElementById('btn-edit-mode');
            if (editBtn) {
              editBtn.textContent = 'âœ“ í¸ì§‘ ëª¨ë“œ í™œì„±í™”ë¨';
              editBtn.disabled = true;
            }
            // í˜„ì¬ ë¬¸ì œ ë‹¤ì‹œ í‘œì‹œí•˜ì—¬ ì €ì¥ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            displayProblem(currentIndex);
            return true;
          }
        } catch (err) {
          if (err.name !== 'AbortError') {
            alert('íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜: ' + err.message);
            console.error('íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜:', err);
          }
        }
        return false;
      }
      
      // í¸ì§‘ ëª¨ë“œ í™œì„±í™”
      async function enableEditMode() {
        const success = await openResultsFileForEditing();
        if (success) {
          alert('í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ìˆ˜ì •í•œ ë‚´ìš©ì„ íŒŒì¼ì— ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }
      }
      
      // ëª¨ë“  íŒŒì¼ ë¡œë“œ
      async function loadAllFiles() {
        const loadingDiv = document.getElementById('file-loading');
        const fileInputSection = document.getElementById('file-input-section');
        loadingDiv.style.display = 'block';
        loadingDiv.textContent = 'íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘...';
        
        try {
          // combined_input.jsonl ë¡œë“œ
          loadingDiv.textContent = 'combined_input.jsonl ì²˜ë¦¬ ì¤‘...';
          const combinedText = await readTextFile(selectedFiles.combined);
          combinedInputData = combinedText.trim().split('\n')
            .filter(line => line.trim())
            .map(line => {
              try {
                return JSON.parse(line);
              } catch (e) {
                console.warn('JSON íŒŒì‹± ì˜¤ë¥˜:', line);
                return null;
              }
            })
            .filter(item => item !== null);
          
          // results.jsonl ë¡œë“œ
          loadingDiv.textContent = 'results.jsonl ì²˜ë¦¬ ì¤‘...';
          const resultsText = await readTextFile(selectedFiles.results);
          resultsData = resultsText.trim().split('\n')
            .filter(line => line.trim())
            .map(line => {
              try {
                return JSON.parse(line);
              } catch (e) {
                console.warn('JSON íŒŒì‹± ì˜¤ë¥˜:', line);
                return null;
              }
            })
            .filter(item => item !== null);
          
          // unitKnowledge.json ë¡œë“œ (í•„ìˆ˜)
          loadingDiv.textContent = 'unitKnowledge.json ì²˜ë¦¬ ì¤‘...';
          const ukJson = await readJsonFile(selectedFiles.unitKnowledge);
          unitKnowledgeList = Object.values(ukJson)[0] || [];
          // unitKnowledge ê¸°ë°˜ unit ì •ë³´ ë§µ êµ¬ì„±
          unitsData = {};
          unitKnowledgeList.forEach(row => {
            if (!unitsData[row.unit_id]) {
              unitsData[row.unit_id] = {
                unit_id: row.unit_id,
                unit_name: row.unit_name,
                curriculum_name: row.curriculum_name
              };
            }
          });
          
          // criteria.jsonl ë¡œë“œ (ì„ íƒì‚¬í•­)
          if (selectedFiles.criteria) {
            loadingDiv.textContent = 'criteria.jsonl ì²˜ë¦¬ ì¤‘...';
            const criteriaText = await readTextFile(selectedFiles.criteria);
            criteriaData = criteriaText.trim().split('\n')
              .filter(line => line.trim())
              .map(line => {
                try {
                  return JSON.parse(line);
                } catch (e) {
                  console.warn('JSON íŒŒì‹± ì˜¤ë¥˜:', line);
                  return null;
                }
              })
              .filter(item => item !== null);
          } else {
            criteriaData = [];
          }
          
          // ë°ì´í„° ì¡°ì¸
          loadingDiv.textContent = 'ë°ì´í„° ì¡°ì¸ ì¤‘...';
          mergeData();
          
          // UI í‘œì‹œ
          loadingDiv.style.display = 'none';
          fileInputSection.style.display = 'none';
          document.getElementById('navigation-bar').style.display = 'flex';
          document.getElementById('main-content').style.display = 'grid';
          
          // File System Access API ì§€ì› ì—¬ë¶€ í™•ì¸
          const editModeBtn = document.getElementById('btn-edit-mode');
          if (editModeBtn) {
            if (!window.showOpenFilePicker) {
              editModeBtn.style.display = 'none';
            }
          }
          
          // ì²« ë²ˆì§¸ ë¬¸ì œ í‘œì‹œ
          displayProblem(0);
          
        } catch (error) {
          loadingDiv.innerHTML = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
          loadingDiv.style.background = '#ffe6e6';
          loadingDiv.style.borderColor = '#ffcccc';
          console.error('Error loading files:', error);
        }
      }

      // ë°ì´í„° ì¡°ì¸
      function mergeData() {
        // results.jsonlì„ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì¸
        const resultsMap = {};
        resultsData.forEach(item => {
          resultsMap[item.problem_id] = item;
        });

        // combined_input.jsonlê³¼ ì¡°ì¸
        const combinedMap = {};
        combinedInputData.forEach(item => {
          combinedMap[item.problem_id] = item;
        });

        // criteria.jsonlê³¼ ì¡°ì¸ (problem_idë³„ë¡œ ë°°ì—´ë¡œ ì €ì¥)
        const criteriaMap = {};
        criteriaData.forEach(item => {
          if (!criteriaMap[item.problem_id]) {
            criteriaMap[item.problem_id] = [];
          }
          criteriaMap[item.problem_id].push(item);
        });

        // problem_idë¡œ ì¡°ì¸
        mergedData = [];
        resultsData.forEach(result => {
          const problemId = result.problem_id;
          const combined = combinedMap[problemId] || {};
          const criteria = criteriaMap[problemId] || [];
          
          // unit_candidatesì˜ unit_idë¡œ units.json ì¡°ì¸
          const enrichedUnitCandidates = (result.unit_candidates || []).map(candidate => {
            const unitInfo = unitsData[candidate.unit_id] || {};
            const enrichedCandidate = {
              ...candidate,
              unit_name: unitInfo.unit_name || 'ì•Œ ìˆ˜ ì—†ìŒ',
              curriculum_name: unitInfo.curriculum_name || 'ì•Œ ìˆ˜ ì—†ìŒ',
              unit_necessity: candidate.unit_necessity !== undefined ? candidate.unit_necessity : null
            };
            
            // valid_knowledges ë˜ëŠ” knowledgesì— necessity í•„ë“œ ì¶”ê°€
            const knowledges = enrichedCandidate.valid_knowledges || enrichedCandidate.knowledges || [];
            if (knowledges.length > 0) {
              const enrichedKnowledges = knowledges.map(k => ({
                ...k,
                knowledge_necessity: k.knowledge_necessity !== undefined ? k.knowledge_necessity : null
              }));
              if (enrichedCandidate.valid_knowledges) {
                enrichedCandidate.valid_knowledges = enrichedKnowledges;
              } else if (enrichedCandidate.knowledges) {
                enrichedCandidate.knowledges = enrichedKnowledges;
              }
            }
            
            return enrichedCandidate;
          });
          
          mergedData.push({
            problem_id: problemId,
            // combined_inputì—ì„œ ê°€ì ¸ì˜¬ ë°ì´í„°
            problem_html: combined.problem_html || {},
            // resultsì—ì„œ ê°€ì ¸ì˜¬ ë°ì´í„°
            behavior_area: result.behavior_area,
            behavior_reason: result.behavior_reason,
            behavior_area_confirmed: result.behavior_area_confirmed || '',
            unit_added: Array.isArray(result.unit_added) ? result.unit_added : [],
            comment: result.comment || '',
            unit_candidates: enrichedUnitCandidates,
            // criteriaì—ì„œ ê°€ì ¸ì˜¬ ë°ì´í„°
            criteria: criteria
          });
        });
      }

      // ë¬¸ì œ í‘œì‹œ
      function displayProblem(index) {
        if (index < 0 || index >= mergedData.length) return;
        
        currentIndex = index;
        const data = mergedData[index];
        
        // ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
        document.getElementById('problem-counter').textContent = `${index + 1} / ${mergedData.length}`;
        document.getElementById('btn-first').disabled = index === 0;
        document.getElementById('btn-prev10').disabled = index === 0;
        document.getElementById('btn-prev').disabled = index === 0;
        document.getElementById('btn-next').disabled = index === mergedData.length - 1;
        document.getElementById('btn-next10').disabled = index >= mergedData.length - 1;
        document.getElementById('btn-last').disabled = index === mergedData.length - 1;
        
        // ì™¼ìª½: ë¬¸ì œ ë‚´ìš© ë Œë”ë§
        const problemContent = document.getElementById('problem-content');
        const problemHtml = data.problem_html || {};
        
        let html = '';
        if (problemHtml.question_html) {
          html += '<div style="margin-bottom: 20px;"><h3 style="margin-bottom: 10px;">ë¬¸ì œ</h3>' + problemHtml.question_html + '</div>';
        }
        if (problemHtml.choice_html) {
          html += '<div style="margin-bottom: 20px;"><h3 style="margin-bottom: 10px;">ì„ íƒì§€</h3>' + problemHtml.choice_html + '</div>';
        }
        if (problemHtml.explanation_html) {
          html += '<div style="margin-bottom: 20px;"><h3 style="margin-bottom: 10px;">í•´ì„¤</h3>' + problemHtml.explanation_html + '</div>';
        }
        if (problemHtml.correct_answer_html) {
          html += '<div style="margin-bottom: 20px;"><h3 style="margin-bottom: 10px;">ì •ë‹µ</h3>' + problemHtml.correct_answer_html + '</div>';
        }
        
        problemContent.innerHTML = html || '<p>ë¬¸ì œ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        
        // KaTeX ë Œë”ë§
        if (window.renderMathInElement) {
          renderMathInElement(problemContent, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false,
            trust: true
          });
        }
        
        // ì˜¤ë¥¸ìª½: ì •ë³´ í‘œì‹œ
        const infoContent = document.getElementById('info-content');
        let infoHtml = '';
        
        // Problem ID
        infoHtml += '<div class="info-section">';
        infoHtml += '<h3>ë¬¸ì œ ì •ë³´</h3>';
        infoHtml += '<div class="info-field"><div class="info-label">ë¬¸í•­ID</div><div class="info-value">' + data.problem_id + '</div></div>';
        infoHtml += '</div>';
        
        // Behavior ì •ë³´
        if (data.behavior_area || data.behavior_reason) {
          infoHtml += '<div class="info-section">';
          infoHtml += '<h3>í–‰ë™ ì˜ì—­</h3>';
          if (data.behavior_area) {
            const confirmedArea = data.behavior_area_confirmed || '';
            infoHtml += '<div class="info-field">';
            infoHtml += '<div class="info-label">ì˜ì—­</div>';
            infoHtml += '<div class="info-value behavior-area-row">';
            infoHtml += '<div class="behavior-area-original">' + escapeHtml(data.behavior_area) + '</div>';
            infoHtml += getBehaviorAreaDropdownHtml(index, confirmedArea);
            infoHtml += '</div>';
            infoHtml += '</div>';
          }
          if (data.behavior_reason) {
            infoHtml += '<div class="info-field"><div class="info-label">ì´ìœ </div><div class="info-value">' + escapeHtml(data.behavior_reason) + '</div></div>';
          }
          infoHtml += '</div>';
        }
        
        // Unit Candidates
        if (data.unit_candidates && data.unit_candidates.length > 0) {
          infoHtml += '<div class="info-section">';
          infoHtml += '<h3>ë‹¨ì› í›„ë³´</h3>';
          
          // criteriaì—ì„œ knowledge_checked ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const criteriaKnowledgeMap = {};
          if (data.criteria && data.criteria.length > 0) {
            data.criteria.forEach(item => {
              if (item.knowledge_id && item.knowledge_checked !== undefined) {
                criteriaKnowledgeMap[item.knowledge_id] = item.knowledge_checked;
              }
            });
          }
          
          data.unit_candidates.forEach((candidate, unitIdx) => {
            const unitId = candidate.unit_id;
            infoHtml += '<div class="unit-candidate">';
            infoHtml += '<div class="unit-candidate-header">';
            infoHtml += '<div class="unit-name-group">';
            infoHtml += '<span class="unit-name">' + escapeHtml(candidate.unit_name || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</span>';
            infoHtml += '<span class="unit-meta">' + escapeHtml(candidate.curriculum_name || '') + '</span>';
            infoHtml += '<span class="confidence-score">ì‹ ë¢°ë„: ' + (candidate.confidence_score ? (candidate.confidence_score * 100).toFixed(2) + '%' : 'N/A') + '</span>';
            infoHtml += '</div>'; // unit-name-group
            const unitNecessity = candidate.unit_necessity;
            infoHtml += getNecessityControlsHtml(
              'setUnitNecessity(' + index + ', ' + unitIdx + ', true)',
              'setUnitNecessity(' + index + ', ' + unitIdx + ', false)',
              unitNecessity === true,
              unitNecessity === false
            );
            infoHtml += '</div>'; // unit-candidate-header
            
            const knowledges = candidate.valid_knowledges || candidate.knowledges || [];
            if (knowledges.length > 0) {
              knowledges.forEach((knowledge, knowIdx) => {
                const knowledgeId = knowledge.knowledge_id;
                const knowledgeChecked = criteriaKnowledgeMap[knowledgeId] || false;
                const knowledgeNecessity = knowledge.knowledge_necessity;
                
                infoHtml += '<div class="knowledge-item">';
                infoHtml += '<div class="knowledge-name-row">';
                infoHtml += '<div class="knowledge-name">';
                infoHtml += '<span>' + escapeHtml(knowledge.knowledge_name || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</span>';
                if (knowledgeChecked) {
                  infoHtml += '<span class="knowledge-checked-icon">âœ…</span>';
                }
                infoHtml += '</div>'; // knowledge-name
                infoHtml += getNecessityControlsHtml(
                  'setKnowledgeNecessity(' + index + ', ' + unitIdx + ', ' + knowIdx + ', true)',
                  'setKnowledgeNecessity(' + index + ', ' + unitIdx + ', ' + knowIdx + ', false)',
                  knowledgeNecessity === true,
                  knowledgeNecessity === false
                );
                infoHtml += '</div>'; // knowledge-name-row
                infoHtml += '</div>';
              });
            }
            
            infoHtml += '</div>';
          });
          
          // unit_added í‘œì‹œ (ë‹¨ì› í›„ë³´ì™€ ë™ì¼í•œ ì¹´ë“œ ë””ìì¸, í…Œë‘ë¦¬ë§Œ ë¹¨ê°„ìƒ‰)
          if (data.unit_added && data.unit_added.length > 0) {
            data.unit_added.forEach((ua, addIdx) => {
              const unitInfo = unitsData[ua.unit_id] || {};
              const knowledgesAdded = ua.valid_knowledges || ua.knowledges || [];
              
              infoHtml += '<div class="unit-candidate unit-candidate-added">';
              infoHtml += '<div class="unit-candidate-header">';
              infoHtml += '<div class="unit-name-group">';
              infoHtml += '<span class="unit-name">' + escapeHtml(unitInfo.unit_name || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</span>';
              infoHtml += '<span class="unit-meta">' + escapeHtml(unitInfo.curriculum_name || '') + '</span>';
              infoHtml += '</div>'; // unit-name-group
              infoHtml += '</div>'; // unit-candidate-header
              
              if (knowledgesAdded && knowledgesAdded.length > 0) {
                knowledgesAdded.forEach((k, kIdx) => {
                  const knowledgeChecked = criteriaKnowledgeMap[k.knowledge_id] || false;
                  infoHtml += '<div class="unit-added-knowledge">';
                  infoHtml += '<div class="knowledge-name">';
                  infoHtml += '<span>' + escapeHtml(k.knowledge_name || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</span>';
                  if (knowledgeChecked) {
                    infoHtml += '<span class="knowledge-checked-icon">âœ…</span>';
                  }
                  infoHtml += '</div>'; // knowledge-name
                  infoHtml += '<button type="button" class="btn-unit-added-delete" onclick="removeUnitAdded(' + index + ', ' + addIdx + ', ' + kIdx + ')">ì‚­ì œ</button>';
                  infoHtml += '</div>';
                });
              }
              
              infoHtml += '</div>';
            });
          }

          // ë‹¨ì›/ì§€ì‹ ê²€ìƒ‰ UI
          infoHtml += getKnowledgeSearchHtml(data.problem_id, index);

          infoHtml += '</div>';
        }
        
        // í†µí•© ìœ í˜• ì„¹ì…˜
        if (data.criteria && data.criteria.length > 0) {
          // category_base_name ì¤‘ë³µ ì œê±°
          const categoryNames = [];
          const seenCategories = new Set();
          data.criteria.forEach(item => {
            if (item.category_base_name && !seenCategories.has(item.category_base_name)) {
              seenCategories.add(item.category_base_name);
              categoryNames.push(item.category_base_name);
            }
          });
          
          if (categoryNames.length > 0) {
            infoHtml += '<div class="info-section">';
            infoHtml += '<h3 style="color: #667eea;">í†µí•© ìœ í˜•</h3>';
            categoryNames.forEach((name, idx) => {
              infoHtml += '<div class="info-value" style="margin-bottom: 8px;">' + escapeHtml(name) + '</div>';
            });
            infoHtml += '</div>';
          }
        }
        
        // í†µìœ  ê¸°ì¤€ ì„¹ì…˜
        if (data.criteria && data.criteria.length > 0) {
          // unit_idë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ í‘œì‹œ (results.jsonlê³¼ ë™ì¼í•œ í˜•ì‹)
          const unitGroups = {};
          const criteriaKnowledgeMap = {};
          data.criteria.forEach(item => {
            const unitId = item.unit_id;
            if (!unitGroups[unitId]) {
              const unitInfo = unitsData[unitId] || {};
              unitGroups[unitId] = {
                unit_id: unitId,
                unit_name: unitInfo.unit_name || 'ì•Œ ìˆ˜ ì—†ìŒ',
                curriculum_name: unitInfo.curriculum_name || 'ì•Œ ìˆ˜ ì—†ìŒ',
                knowledges: []
              };
            }
            
            // knowledge ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
            const knowledgeExists = unitGroups[unitId].knowledges.some(k => k.knowledge_id === item.knowledge_id);
            if (!knowledgeExists && item.knowledge_id) {
              unitGroups[unitId].knowledges.push({
                knowledge_id: item.knowledge_id,
                knowledge_name: item.knowledge_name,
                knowledge_checked: item.knowledge_checked || false
              });
            }
            
            // knowledge_checked ë§µ ì €ì¥
            if (item.knowledge_id && item.knowledge_checked !== undefined) {
              criteriaKnowledgeMap[item.knowledge_id] = item.knowledge_checked;
            }
          });
          
          if (Object.keys(unitGroups).length > 0) {
            infoHtml += '<div class="info-section">';
            infoHtml += '<h3 style="color: #667eea;">DB ê¸°ì¤€</h3>';
            
            // ê° unit í‘œì‹œ (results.jsonlì˜ unit_candidatesì™€ ë™ì¼í•œ í˜•ì‹)
            Object.values(unitGroups).forEach(unit => {
              infoHtml += '<div class="unit-candidate">';
              infoHtml += '<div class="unit-candidate-header">';
              infoHtml += '<div class="unit-name-group">';
              infoHtml += '<span class="unit-name">' + escapeHtml(unit.unit_name) + '</span>';
              infoHtml += '<span class="unit-meta">' + escapeHtml(unit.curriculum_name) + '</span>';
              infoHtml += '</div>';
              infoHtml += '</div>';
              
              // knowledge í‘œì‹œ
              if (unit.knowledges.length > 0) {
                unit.knowledges.forEach(knowledge => {
                  const knowledgeChecked = knowledge.knowledge_checked || false;
                  infoHtml += '<div class="knowledge-item">';
                  infoHtml += '<div class="knowledge-name">';
                  infoHtml += '<span>' + escapeHtml(knowledge.knowledge_name || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</span>';
                  if (knowledgeChecked) {
                    infoHtml += '<span class="knowledge-checked-icon">âœ…</span>';
                  }
                  infoHtml += '</div>';
                  infoHtml += '</div>';
                });
              }
              
              infoHtml += '</div>';
            });
            
            infoHtml += '</div>';
          }
        }
        
        // Comment ì„¹ì…˜
        infoHtml += '<div class="info-section comment-section">';
        infoHtml += '<h3>ê²€ìˆ˜ ì½”ë©˜íŠ¸</h3>';
        infoHtml += '<textarea class="comment-textarea" id="comment-' + index + '" onchange="updateComment(' + index + ', this.value)">' + escapeHtml(data.comment || '') + '</textarea>';
        infoHtml += '</div>';
        
        // ì €ì¥ ì„¹ì…˜ (í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ëœ ê²½ìš°ë§Œ í‘œì‹œ)
        if (resultsFileHandle) {
          infoHtml += '<div class="save-section">';
          infoHtml += '<button class="btn-save-file" id="btn-save" onclick="saveResultsFile()">ê²°ê³¼ ì €ì¥</button>';
          infoHtml += '</div>';
        }
        
        infoContent.innerHTML = infoHtml || '<p>ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

        // KaTeX ë Œë”ë§ (í–‰ë™ ì˜ì—­ ë“± ìš°ì¸¡ ì˜ì—­ ë‚´ ìˆ˜ì‹ í¬í•¨)
        if (window.renderMathInElement) {
          renderMathInElement(infoContent, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false,
            trust: true
          });
        }
      }

      // ë¬¸ì œ ë³€ê²½
      function changeProblem(delta) {
        const newIndex = currentIndex + delta;
        if (newIndex >= 0 && newIndex < mergedData.length) {
          displayProblem(newIndex);
        }
      }

      // ë§¨ ì•ìœ¼ë¡œ ì´ë™
      function goToFirst() {
        if (mergedData.length > 0) {
          displayProblem(0);
        }
      }

      // ë§¨ ë’¤ë¡œ ì´ë™
      function goToLast() {
        if (mergedData.length > 0) {
          displayProblem(mergedData.length - 1);
        }
      }

      // ë²ˆí˜¸ë¡œ ê²€ìƒ‰
      function searchByIndex() {
        const indexInput = document.getElementById('search-index');
        const index = parseInt(indexInput.value);
        if (index >= 1 && index <= mergedData.length) {
          displayProblem(index - 1);
          indexInput.value = '';
        } else {
          alert(`ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1-${mergedData.length})`);
        }
      }

      // ë²ˆí˜¸ ê²€ìƒ‰ ì—”í„° í‚¤ ì§€ì›
      function handleIndexSearch(event) {
        if (event.key === 'Enter') {
          searchByIndex();
        }
      }

      // Problem IDë¡œ ê²€ìƒ‰
      function searchByProblemId() {
        const problemIdInput = document.getElementById('search-problem-id');
        const problemId = parseInt(problemIdInput.value);
        if (!problemId || isNaN(problemId)) {
          alert('ì˜¬ë°”ë¥¸ Problem IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
          return;
        }
        
        const index = mergedData.findIndex(item => item.problem_id === problemId);
        if (index !== -1) {
          displayProblem(index);
          problemIdInput.value = '';
        } else {
          alert(`Problem ID ${problemId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
        }
      }

      // Problem ID ê²€ìƒ‰ ì—”í„° í‚¤ ì§€ì›
      function handleProblemIdSearch(event) {
        if (event.key === 'Enter') {
          searchByProblemId();
        }
      }

      // Unit necessity ì„¤ì •
      function setUnitNecessity(problemIndex, unitIndex, value) {
        if (mergedData[problemIndex] && mergedData[problemIndex].unit_candidates && mergedData[problemIndex].unit_candidates[unitIndex]) {
          const candidate = mergedData[problemIndex].unit_candidates[unitIndex];
          // ê°™ì€ ê°’ì´ë©´ nullë¡œ ì„¤ì • (í† ê¸€)
          if (candidate.unit_necessity === value) {
            candidate.unit_necessity = null;
          } else {
            candidate.unit_necessity = value;
          }
          // UI ì—…ë°ì´íŠ¸
          displayProblem(problemIndex);
        }
      }
      
      // Knowledge necessity ì„¤ì •
      function setKnowledgeNecessity(problemIndex, unitIndex, knowledgeIndex, value) {
        if (mergedData[problemIndex] && mergedData[problemIndex].unit_candidates && mergedData[problemIndex].unit_candidates[unitIndex]) {
          const candidate = mergedData[problemIndex].unit_candidates[unitIndex];
          const knowledges = candidate.valid_knowledges || candidate.knowledges || [];
          if (knowledges[knowledgeIndex]) {
            const knowledge = knowledges[knowledgeIndex];
            // ê°™ì€ ê°’ì´ë©´ nullë¡œ ì„¤ì • (í† ê¸€)
            if (knowledge.knowledge_necessity === value) {
              knowledge.knowledge_necessity = null;
            } else {
              knowledge.knowledge_necessity = value;
            }
            // UI ì—…ë°ì´íŠ¸
            displayProblem(problemIndex);
          }
        }
      }
      
      // Comment ì—…ë°ì´íŠ¸
      function updateComment(problemIndex, value) {
        if (mergedData[problemIndex]) {
          mergedData[problemIndex].comment = value || '';
        }
      }

      // êµìœ¡ê³¼ì • ì„ íƒ
      function selectCurriculum(problemIndex, curriculumName) {
        const problem = mergedData[problemIndex];
        if (!problem) return;
        const state = getKnowledgeSearchState(problem.problem_id);
        state.curriculum_name = curriculumName || '';
        // êµìœ¡ê³¼ì •ì´ ë°”ë€Œë©´ ë‹¨ì›/ê°œë… ì´ˆê¸°í™”
        state.unit_id = null;
        state.knowledge_id = null;
        displayProblem(problemIndex);
      }

      // ë‹¨ì› ì„ íƒ
      function selectUnit(problemIndex, unitId) {
        const problem = mergedData[problemIndex];
        if (!problem) return;
        const state = getKnowledgeSearchState(problem.problem_id);
        state.unit_id = unitId || null;
        state.knowledge_id = null;
        // ë‹¨ì›ì´ ì •í•´ì§€ë©´ êµìœ¡ê³¼ì •ë„ ìë™ ì„¤ì •
        if (unitId) {
          const match = unitKnowledgeList.find(item => item.unit_id === unitId);
          if (match) {
            state.curriculum_name = match.curriculum_name;
          }
        }
        displayProblem(problemIndex);
      }

      // ê°œë… ì„ íƒ
      function selectKnowledge(problemIndex, knowledgeId) {
        const problem = mergedData[problemIndex];
        if (!problem) return;
        const state = getKnowledgeSearchState(problem.problem_id);
        state.knowledge_id = knowledgeId || null;
        if (knowledgeId) {
          const match = unitKnowledgeList.find(item => item.knowledge_id === knowledgeId);
          if (match) {
            state.unit_id = match.unit_id;
            state.curriculum_name = match.curriculum_name;
          }
        }
        displayProblem(problemIndex);
      }

      // "+" ë²„íŠ¼ìœ¼ë¡œ unit_addedì— ì¶”ê°€
      function addUnitFromSearch(problemIndex) {
        const problem = mergedData[problemIndex];
        if (!problem) return;
        const state = getKnowledgeSearchState(problem.problem_id);
        if (!state.knowledge_id) {
          alert('ì¶”ê°€í•  ê°œë…ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        const match = unitKnowledgeList.find(item => item.knowledge_id === state.knowledge_id);
        if (!match) {
          alert('ì„ íƒí•œ ê°œë…ì— í•´ë‹¹í•˜ëŠ” ë‹¨ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        if (!Array.isArray(problem.unit_added)) {
          problem.unit_added = [];
        }
        // unit_id ê¸°ì¤€ìœ¼ë¡œ ë¬¶ê¸°: ë™ì¼ unitì´ë©´ ê°™ì€ entryì— ì§€ì‹ ì¶”ê°€
        let targetUnit = problem.unit_added.find(ua => ua.unit_id === match.unit_id);
        if (!targetUnit) {
          targetUnit = {
            unit_id: match.unit_id,
            confidence_score: null,
            unit_necessity: null,
            valid_knowledges: []
          };
          problem.unit_added.push(targetUnit);
        }
        const knowledges = targetUnit.valid_knowledges || targetUnit.knowledges || [];
        const already = knowledges.some(k => k.knowledge_id === match.knowledge_id);
        if (!already) {
          knowledges.push({
            knowledge_id: match.knowledge_id,
            knowledge_name: match.knowledge_name,
            knowledge_necessity: null
          });
          targetUnit.valid_knowledges = knowledges;
        }
        displayProblem(problemIndex);
      }

      // unit_addedì—ì„œ ì„ íƒ ì§€ì‹ ì‚­ì œ
      function removeUnitAdded(problemIndex, addIndex, knowledgeIndex) {
        const problem = mergedData[problemIndex];
        if (!problem || !Array.isArray(problem.unit_added)) return;
        const target = problem.unit_added[addIndex];
        if (!target) return;
        const knowledges = target.valid_knowledges || target.knowledges || [];
        if (knowledges[knowledgeIndex]) {
          knowledges.splice(knowledgeIndex, 1);
          if (target.valid_knowledges) target.valid_knowledges = knowledges;
          if (target.knowledges) target.knowledges = knowledges;
        }
        // ì§€ì‹ì´ ëª¨ë‘ ì—†ì–´ì§€ë©´ unit_added í•­ëª© ì œê±°
        if (knowledges.length === 0) {
          problem.unit_added.splice(addIndex, 1);
        }
        displayProblem(problemIndex);
      }

      // í–‰ë™ ì˜ì—­ í™•ì • ê°’ ì„¤ì •
      function setBehaviorAreaConfirmed(problemIndex, value) {
        if (!mergedData[problemIndex]) return;
        mergedData[problemIndex].behavior_area_confirmed = value || '';
        // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        const dropdowns = document.querySelectorAll('.behavior-dropdown');
        dropdowns.forEach(d => d.classList.remove('open'));
        // UI ê°±ì‹ 
        displayProblem(problemIndex);
      }

      // ë“œë¡­ë‹¤ìš´ ê²€ìƒ‰ í•„í„°
      function filterDropdown(inputEl) {
        const term = (inputEl.value || '').toLowerCase();
        const menu = inputEl.closest('.behavior-dropdown-menu');
        if (!menu) return;
        const items = menu.querySelectorAll('.behavior-dropdown-item-option');
        items.forEach(item => {
          const label = (item.getAttribute('data-label') || item.textContent || '').toLowerCase();
          if (term === '' || label.includes(term)) {
            item.classList.remove('dropdown-item-hidden');
          } else {
            item.classList.add('dropdown-item-hidden');
          }
        });
      }

      // ë“œë¡­ë‹¤ìš´ í† ê¸€ (ê²€ìƒ‰ í•„ë“œ ìë™ í¬ì»¤ìŠ¤, í•˜ìœ„ ì„ íƒ ìœ ì§€)
      function toggleBehaviorDropdown(buttonEl) {
        const dropdown = buttonEl.closest('.behavior-dropdown');
        if (!dropdown) return;
        const menu = dropdown.querySelector('.behavior-dropdown-menu');
        const searchInput = dropdown.querySelector('.behavior-dropdown-search');
        const isOpen = dropdown.classList.contains('open');

        // ëª¨ë‘ ë‹«ê¸°
        document.querySelectorAll('.behavior-dropdown.open').forEach(d => d.classList.remove('open'));

        if (!isOpen) {
          // ì—´ê¸°
          dropdown.classList.add('open');
          // ê²€ìƒ‰ì–´ ì´ˆê¸°í™” ë° ì „ì²´ ì˜µì…˜ ë³´ì´ê¸°
          if (searchInput) {
            searchInput.value = '';
            filterDropdown(searchInput);
            // ì‚´ì§ ì§€ì—° í›„ í¬ì»¤ìŠ¤
            setTimeout(() => searchInput.focus(), 0);
          }
        }
      }

      // ë“œë¡­ë‹¤ìš´ ì—´ê¸°/ë‹«ê¸°
      function toggleBehaviorDropdown(buttonEl) {
        const dropdown = buttonEl.closest('.behavior-dropdown');
        if (!dropdown) return;
        const isOpen = dropdown.classList.contains('open');

        // ìƒìœ„ ì„ íƒë§Œ ìœ ì§€í•˜ê³  í•˜ìœ„ ì„ íƒì€ ë¦¬ì…‹ (DOM ë¼ë²¨ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸)
        const type = buttonEl.getAttribute('data-dropdown-type');
        const problemIndexAttr = buttonEl.getAttribute('data-problem-index');
        const problemIndex = problemIndexAttr ? parseInt(problemIndexAttr, 10) : null;
        if (problemIndex !== null && !isNaN(problemIndex)) {
          const problem = mergedData[problemIndex];
          if (problem) {
            const state = getKnowledgeSearchState(problem.problem_id);
            const row = buttonEl.closest('.knowledge-search-container') || buttonEl.closest('.knowledge-search-row');
            const setLabel = (t, text) => {
              if (!row) return;
              const btn = row.querySelector('.behavior-dropdown-toggle[data-dropdown-type="' + t + '"]');
              if (btn) {
                const lbl = btn.querySelector('.behavior-dropdown-label');
                if (lbl) {
                  lbl.textContent = text;
                  lbl.classList.add('placeholder');
                }
              }
            };
            if (type === 'curriculum') {
              state.unit_id = null;
              state.knowledge_id = null;
              setLabel('unit', 'ë‹¨ì› ì„ íƒ');
              setLabel('knowledge', 'ê°œë… ì„ íƒ');
            } else if (type === 'unit') {
              state.knowledge_id = null;
              setLabel('knowledge', 'ê°œë… ì„ íƒ');
            }
          }
        }

        // ëª¨ë‘ ë‹«ê¸°
        document.querySelectorAll('.behavior-dropdown.open').forEach(d => d.classList.remove('open'));
        if (!isOpen) {
          dropdown.classList.add('open');
        }
      }
      
      // results.jsonl íŒŒì¼ ì €ì¥
      async function saveResultsFile() {
        if (!resultsFileHandle) {
          alert('íŒŒì¼ í•¸ë“¤ì´ ì—†ìŠµë‹ˆë‹¤. Chrome/Edgeì—ì„œ íŒŒì¼ì„ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.');
          return;
        }
        
        try {
          // mergedDataë¥¼ resultsData í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          const resultsToSave = mergedData.map(item => {
            const result = {
              problem_id: item.problem_id,
              behavior_area: item.behavior_area,
              behavior_reason: item.behavior_reason,
              behavior_area_confirmed: item.behavior_area_confirmed || '',
              unit_added: Array.isArray(item.unit_added) ? item.unit_added : [],
              comment: item.comment || '',
              unit_candidates: item.unit_candidates.map(unit => {
                const unitCandidate = {
                  unit_id: unit.unit_id,
                  confidence_score: unit.confidence_score,
                  unit_necessity: unit.unit_necessity !== undefined ? unit.unit_necessity : null
                };
                
                // valid_knowledges ë˜ëŠ” knowledges ì²˜ë¦¬
                const knowledges = unit.valid_knowledges || unit.knowledges || [];
                if (knowledges.length > 0) {
                  unitCandidate.valid_knowledges = knowledges.map(k => ({
                    knowledge_id: k.knowledge_id,
                    knowledge_name: k.knowledge_name,
                    knowledge_necessity: k.knowledge_necessity !== undefined ? k.knowledge_necessity : null
                  }));
                } else {
                  unitCandidate.valid_knowledges = [];
                }
                
                return unitCandidate;
              })
            };
            return result;
          });
          
          // JSONL í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          const jsonlContent = resultsToSave.map(item => JSON.stringify(item, null, 0)).join('\n') + '\n';
          
          // íŒŒì¼ì— ì“°ê¸°
          const writable = await resultsFileHandle.createWritable();
          await writable.write(jsonlContent);
          await writable.close();
          
          // resultsDataë„ ì—…ë°ì´íŠ¸
          resultsData = resultsToSave;
          
          alert('ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (error) {
          alert('íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
          console.error('Save error:', error);
        }
      }

      // HTML ì´ìŠ¤ì¼€ì´í”„
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', () => {
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        setupDragAndDrop();
        // íŒŒì¼ ì…ë ¥ ìƒíƒœ í™•ì¸
        checkAllFilesSelected();

        // í–‰ë™ ì˜ì—­ ë“œë¡­ë‹¤ìš´: ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.behavior-dropdown')) {
            document.querySelectorAll('.behavior-dropdown.open').forEach(d => d.classList.remove('open'));
          }
        });
      });
    </script>
  </body>
</html>
